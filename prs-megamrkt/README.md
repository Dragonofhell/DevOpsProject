# Описание
Утилита принимает на вход ссылку ( в т.ч. с фильтрами) и разбирает данные в формате: - Наименование - Цена - Процент кешбека - Количество баллов - Реальная цена ( Цена - кешбек) - Ссылка на товар

# Запуск приложения
Для запуска приложения необходимо:
С помощью pyinstaller создать exe file ... etc

1. Скопируйте exe файл в любую директорию
2. Создайте папку config в данной директории
3. Поместите файлы urls.txt и config.json в папку config
4. заполните config.json файл. Параметры для заполнения:
Параметр | Описание | Пример 
----------|----------|----------
|telegram_enable|Включение\отключение отправки сообщений в Telegram| 1 - включено , 0 - выключено
| result_dir | Директория для сохранения результатов выполнения | "config/results_excel"
| min_bonus_amount | Минимальный кешбек (в %), при котором отработает отправка уведомления | "75" | 
| best_bonus_amount | Самые выгодные условия по кешбеку(например при выборе min_bonus_amount, отправлять в отдельного бота только те товары, где кешбек 75%+) | "75" 
| tokenid_top | Отправка  уведомлений через чат-бота с очень выгодными кешбеками ( применяется для best_bonus_amount).  | "6441:AAGBVssAqa1S" |
tokenid | Отправка уведомлений через чат-бота ( применяется для  min_bonus_amount).  | "6486:qAXASGBVz6s9UKs" |
chat_id | id чата, можно узнать из https://api.telegram.org/bot{tokenid}/getUpdates, предварительно отправив сообщение в чат-бот вручную | 329291
5. Заполните urls.txt ссылками на фильтры , пример указан в urls.txt . Также допускается выбрать фильтры в категории . После выбора фильтров, скопируйте ссылку и продублируйте ее в urls.txt , например https://megamarket.ru/catalog/smartfony-android/#?filters=%7B%222B0B1FF4756D49CF84B094522D57ED3D%22%3A%5B%22Xiaomi%22%2C%22Samsung%22%5D%7D
6. Запустите командную строку cmd
7. Выполинте запуск exe файла



# Создание Telegram бота
1. Найдите в telegram @botFather https://t.me/BotFather
2. Выполните создание бота /newbot
3. Введите произвольное имя ( например Кешбек 50%)
4. Введите имя бота ( например cashback_50_bot) 
5. После создания бота необходимо сохранить и продублировать в конфигурационный файл api token
 ```text
Use this token to access the HTTP API:
6351743005:AAGQVEZa63mfmS_VMHeJG2SbRokRPmjRw3w
Keep your token secure and store it safely, it can be used by anyone to control your bot.

For a description of the Bot API, see this page: https://core.telegram.org/bots/api
```

6. Напишите через телеграм боту любое сообщение .
7. Перейдите в браузере по адресу https://api.telegram.org/bot{tokenid}/getUpdates , где tokenid - api токен из п.5. Например https://api.telegram.org/bot6351743005:AAGQVEZa63mfmS_VMHeJG2SbRokRPmjRw3w/getUpdates
8. Найдите из блока from идентификатор вашего пользователя, например 1234567 . Данный параметр необходимо указать в chat_id в config.json
```json
"message":{"message_id":2,"from":{"id":1234567,"is_bot":false,"first_name":"\u0414\u043c\u0438\u0442\u0440\u0438\u0439","username": xxx }}
```
9. Для создания второго бота выполните п.1-6

# Требования
## Необходимые библиотеки Python
Centos 7: sudo pip3 install selenium bs4 beautifulsoup4 pandas openpyxl
 - selenium
 - bs4
 - BeautifulSoup
 - time
 - datetime
 - pandas
 - urllib.parse
 - json
 - random
 - openpyxl
 - ...
## Selenium
https://github.com/mozilla/geckodriver/releases/ Скачать релиз на текущую версию ОС. Необходимо при указании пути в driver_path ( например driver_path = r'E:\\geckodriver.exe')
# Заметки
## 1.0.0
- Ссылку необходимо указывать в коде. - В функции fetch_data(url) намеренно используется ожидание в 5 секунд. Необходимо для корректного отображения html при обработке ссылки с filter - Файл 
Excel формируется в той же директории, где создан проект - Наименование файла формируется из ссылки + текущая дата
## 1.0.1
- Добавлен ввод ссылки из командной строки - Ссылки теперь попадают в файл в виде гиперссылок - мелкие исправления и чистка кода
# Develop
## 1.0.0
- Переработан подход в обработке данных. Теперь сканируется каждая страница с товаром.
## 1.0.1
- Добавлено использование рандомного агента при запуске браузера - Случайное время sleep - В вывод добавлена информация о реальной цене - Добавлено сохранение cookie после завершения работы кода 
и загрузка их при запуске - Ссылка на категорию товара запрашивается при старте программы
## 1.0.2
- Добавлена обработка нескольких ссылок, ввод через запятую
## 1.0.3
- Набор ссылок хранится в файле urls.txt , разделитель - строка - Добавлен подсчет количества ссылок при переборе страниц - Добавлена обработка "Товара нет в наличии" и "404" - Добавлено ожидание 
при редиректе на страницу с вводом капчи
## 1.0.4
- Удалена функция с загрузкой и сохранением cookies - Переработан сценарий обхода капчи - Удалено указание драйвера (Windows) - Для чтения ссылок необходимо создать папку config и файл urls.txt - 
прочие исправления
## 1.0.5
Минимальный набор для запуска: В
- В директории с исполняемым скриптом создана папка config. 
- В директории config присутствуют файлы urls.txt и config.json
- В директории config создана папка из параметра result_dir 
- Добавлена функция отправки уведомлений в Telegram 
- Добавлен config.json для настройки Telegram уведомлений, а также для сохранения данных после выполнения:
 
Параметр | Описание | Пример 
----------|----------|----------
|telegram_enable|Включение\отключение отправки сообщений в Telegram| 1 - включено , 0 - выключено
| result_dir | Директория для сохранения результатов выполнения | "config/results_excel"
| min_bonus_amount | Минимальный кешбек (в %), при котором отработает отправка уведомления | "75" | 
| best_bonus_amount | Самые выгодные условия по кешбеку(например при выборе min_bonus_amount, отправлять в отдельного бота только те товары, где кешбек 75%+) | "75" 
| tokenid_top | Отправка  уведомлений через чат-бота с очень выгодными кешбеками ( применяется для best_bonus_amount).  | "6441:AAGBVssAqa1S" |
tokenid | Отправка уведомлений через чат-бота ( применяется для  min_bonus_amount).  | "6486:qAXASGBVz6s9UKs" |
chat_id | id чата, можно узнать из https://api.telegram.org/bot{tokenid}/getUpdates, предварительно отправив сообщение в чат-бот вручную | 329291 

- Убраны лишние функции - добавлены примеры файлов в папки config
## 1.0.6
- Переработан подход поиска кешбека в зависимости от вида страницы 

Параметр | Описание 
----------|----------
money-bonus xs money-bonus_loyalty pdp-cashback-table__money-bonus|страница с 1 видом кешбека
pdp-cashback-table__money-bonus money-bonus xs money-bonus_loyalty | страница с 2 видами кешбека ( Sberpay и без)

- Добавлена функция отключения отправки сообщения в Telegram